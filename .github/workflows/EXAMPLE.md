# Example: GitHub Actions Workflow in Action

This document demonstrates the automated threat analysis workflow with a real example.

## Scenario

A developer is adding an S3 bucket to store application data. They create a Terraform configuration and open a pull request.

## Step 1: Developer Creates Terraform File

**File**: `infra/terraform/storage.tf`

```terraform
# Application data storage bucket
resource "aws_s3_bucket" "app_data" {
  bucket = "myapp-data-bucket-prod"
  
  tags = {
    Environment = "production"
    Purpose     = "Application data storage"
  }
}

# Make bucket publicly accessible (DANGEROUS!)
resource "aws_s3_bucket_public_access_block" "app_data" {
  bucket = aws_s3_bucket.app_data.id

  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}

# Allow public read access
resource "aws_s3_bucket_policy" "app_data_public" {
  bucket = aws_s3_bucket.app_data.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "PublicReadGetObject"
        Effect    = "Allow"
        Principal = "*"
        Action    = "s3:GetObject"
        Resource  = "${aws_s3_bucket.app_data.arn}/*"
      }
    ]
  })
}
```

## Step 2: Developer Opens Pull Request

```bash
git checkout -b feature/add-s3-storage
git add infra/terraform/storage.tf
git commit -m "Add S3 bucket for application data"
git push origin feature/add-s3-storage
gh pr create --title "Add S3 storage bucket" --body "Storage for application data"
```

## Step 3: GitHub Actions Workflow Triggers

The workflow automatically detects the Terraform file change and starts:

```yaml
# .github/workflows/threat-analysis.yml is triggered
on:
  pull_request:
    types: [opened]
    paths:
      - '**/*.tf'  # âœ… storage.tf matches
```

**Workflow Run**: https://github.com/org/repo/actions/runs/123456

### Console Output

```
ğŸ” Starting Threat Analysis...
âœ… Checked out repository
âœ… Set up Node.js 20
âœ… Set up Python 3.12
âœ… Installed dependencies
ğŸ³ Starting Threat Model API with Docker Compose...
   Creating network "threat-model-platform_default"
   Creating threat-model-platform_api_1 ... done
   Creating threat-model-platform_analysis_1 ... done
âœ… API is ready!

ğŸ“‚ Detecting changed files...
   Found 1 relevant file change:
   - infra/terraform/storage.tf

ğŸ”¬ Running Threat Analysis...
   Collecting Terraform files...
   Collected 1 Terraform file
   Uploading files to API...
   Files uploaded successfully
   Analysis ID: b7f3a2c1-4d8e-4f9a-b2c3-9e5d7a8f6b4c
   Running threat analysis...
   Analysis completed successfully
   Fetching results...
   Results retrieved successfully
   
ğŸ“Š Threat Analysis Summary:
   Total Threats: 3
   Critical: 2
   High: 1
   Medium: 0
   Low: 0

âœ… Report saved: threat-report.json

Creating PR comment...
âœ… Comment posted to PR #42

Creating GitHub Issues for critical threats...
   Processing: Public S3 Bucket...
   âœ… Created issue #156: ğŸ”´ [CRITICAL] Public S3 Bucket in aws_s3_bucket
   Processing: Unrestricted S3 Bucket Policy...
   âœ… Created issue #157: ğŸ”´ [CRITICAL] Unrestricted S3 Bucket Policy in aws_s3_bucket_policy
   
ğŸ“Š Summary
   âœ… Issues created: 2
   
ğŸ“„ Generating report artifacts...
   âœ… threat-report-a1b2c3d4.json
   âœ… threat-report-a1b2c3d4.html
   âœ… THREAT_SUMMARY.md

â¬†ï¸  Uploading artifacts...
   âœ… Uploaded: threat-analysis-report-a1b2c3d4

âš ï¸  WARNING: 2 critical threat(s) detected!
   Consider remediating before merging.

âœ… Threat analysis completed successfully!
```

## Step 4: PR Comment Appears

The workflow posts this comment on the pull request:

---

## ğŸ”’ Automated Threat Analysis Report

### Summary

| Severity | Count |
|----------|-------|
| ğŸ”´ Critical | 2 |
| ğŸŸ  High | 1 |
| ğŸŸ¡ Medium | 0 |
| ğŸŸ¢ Low | 0 |
| **Total** | **3** |

**Average Risk Score**: 9.2

### ğŸ”´ Critical Threats

- **Public S3 Bucket** (aws_s3_bucket)
  - S3 bucket is configured to allow public access
  - Resource: `aws_s3_bucket.app_data`
  - Risk Score: 9.5

- **Unrestricted S3 Bucket Policy** (aws_s3_bucket_policy)
  - Bucket policy allows unrestricted public access to all objects
  - Resource: `aws_s3_bucket_policy.app_data_public`
  - Risk Score: 9.0

### ğŸŸ  High Severity Threats

- **Unencrypted S3 Bucket** (aws_s3_bucket)
  - S3 bucket does not have encryption enabled
  - Resource: `aws_s3_bucket.app_data`

### ğŸ“‹ Actions

- âš ï¸ **Critical threats detected!** Review and remediate before merging.
- GitHub Issues have been created for each critical threat.
- ğŸ“„ Full threat report available in workflow artifacts.
- ğŸ” Review the threat model at `/threat-model/report-1707668400.html`

---

*Generated by [Threat Modeling Platform](https://github.com/threat-model-platform)*

---

## Step 5: GitHub Issues Created

### Issue #156: ğŸ”´ [CRITICAL] Public S3 Bucket in aws_s3_bucket

**Labels**: `security`, `threat-model`, `critical`

---

## Critical Security Threat Detected

A critical security threat was identified during automated threat analysis.

### Threat Details

- **Threat**: Public S3 Bucket
- **Severity**: CRITICAL
- **Risk Score**: 9.5
- **Category**: Data Exposure
- **Likelihood**: HIGH
- **Resource Type**: aws_s3_bucket
- **Resource ID**: `aws_s3_bucket.app_data`
- **Cloud Provider**: AWS

### Description

The S3 bucket has public access enabled through the bucket's public access block configuration. This allows anyone on the internet to potentially list and access objects in the bucket, leading to data exposure, regulatory compliance violations, and reputational damage.

### Recommended Mitigations

#### 1. Enable Block Public Access

**Effort**: low | **Impact**: high

**Steps**:
1. Set `block_public_acls = true` in the `aws_s3_bucket_public_access_block` resource
2. Set `block_public_policy = true` in the `aws_s3_bucket_public_access_block` resource
3. Set `ignore_public_acls = true` in the `aws_s3_bucket_public_access_block` resource
4. Set `restrict_public_buckets = true` in the `aws_s3_bucket_public_access_block` resource

#### 2. Remove Public Bucket Policy

**Effort**: low | **Impact**: high

**Steps**:
1. Remove or modify the `aws_s3_bucket_policy` resource to not allow `Principal = "*"`
2. Use IAM roles or specific principals instead
3. Consider using pre-signed URLs for temporary access

#### 3. Enable Server-Side Encryption

**Effort**: low | **Impact**: medium

**Steps**:
1. Add `aws_s3_bucket_server_side_encryption_configuration` resource
2. Use AWS KMS keys or AES-256 encryption
3. Enforce encryption with bucket policy

### Compliance Impact

This threat affects the following compliance frameworks:

- **DORA**: ORT-07 - Security and Resilience
- **ISO27001**: A.8.2.3 - Handling of Assets
- **SOC2**: CC6.1 - Logical and Physical Access Controls
- **GDPR**: Article 32 - Security of Processing

### References

- https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html
- https://aws.amazon.com/premiumsupport/knowledge-center/secure-s3-resources/
- https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control

---

**Detected in commit**: a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0
**Related PR**: #42
**Analysis Date**: 2026-02-11T14:32:15.000Z

*This issue was automatically created by the Threat Modeling Platform.*

---

## Step 6: Developer Reviews and Fixes

The developer reviews the threats and updates the Terraform file:

**File**: `infra/terraform/storage.tf` (Fixed)

```terraform
# Application data storage bucket (SECURED)
resource "aws_s3_bucket" "app_data" {
  bucket = "myapp-data-bucket-prod"
  
  tags = {
    Environment = "production"
    Purpose     = "Application data storage"
  }
}

# Block all public access (SECURE)
resource "aws_s3_bucket_public_access_block" "app_data" {
  bucket = aws_s3_bucket.app_data.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# Enable server-side encryption
resource "aws_s3_bucket_server_side_encryption_configuration" "app_data" {
  bucket = aws_s3_bucket.app_data.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}

# Enable versioning for data protection
resource "aws_s3_bucket_versioning" "app_data" {
  bucket = aws_s3_bucket.app_data.id
  
  versioning_configuration {
    status = "Enabled"
  }
}

# Private bucket policy (SECURE)
resource "aws_s3_bucket_policy" "app_data_private" {
  bucket = aws_s3_bucket.app_data.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "DenyPublicAccess"
        Effect    = "Deny"
        Principal = "*"
        Action    = "s3:*"
        Resource  = [
          aws_s3_bucket.app_data.arn,
          "${aws_s3_bucket.app_data.arn}/*"
        ]
        Condition = {
          StringNotEquals = {
            "aws:PrincipalOrgID" = "o-xxxxxxxxxx"
          }
        }
      }
    ]
  })
}
```

## Step 7: Push Fixes and Re-run

```bash
git add infra/terraform/storage.tf
git commit -m "Fix: Secure S3 bucket by blocking public access and enabling encryption"
git push origin feature/add-s3-storage
```

### Workflow Runs Again

```
ğŸ” Starting Threat Analysis...
âœ… All checks passed

ğŸ“Š Threat Analysis Summary:
   Total Threats: 0
   Critical: 0
   High: 0
   Medium: 0
   Low: 0

âœ… No critical threats detected!
âœ… PR is ready to merge!
```

### Updated PR Comment

---

## ğŸ”’ Automated Threat Analysis Report

### Summary

| Severity | Count |
|----------|-------|
| ğŸ”´ Critical | 0 |
| ğŸŸ  High | 0 |
| ğŸŸ¡ Medium | 0 |
| ğŸŸ¢ Low | 0 |
| **Total** | **0** |

**Average Risk Score**: 0.0

âœ… **No threats detected in this change!**

Great job securing the S3 bucket! All previous threats have been remediated:
- âœ… Public access blocked
- âœ… Encryption enabled
- âœ… Secure bucket policy

This PR is ready to merge from a security perspective.

---

## Step 8: Merge and Deploy

The developer merges the PR, and the secure configuration is deployed to production.

```bash
gh pr merge 42 --squash
```

On merge to main, the workflow:
1. Commits the threat model to `docs/threat-model/latest.json`
2. Creates a timestamped historical record
3. Does NOT fail the build (no critical threats)

## Step 9: Historical Tracking

The threat model is now tracked in Git:

```
docs/threat-model/
â”œâ”€â”€ latest.json
â”œâ”€â”€ threat-model-20260211-143215.json  # After fix (0 threats)
â””â”€â”€ threat-model-20260211-142015.json  # Before fix (3 threats)
```

This provides:
- âœ… Security posture over time
- âœ… Audit trail for compliance
- âœ… Trend analysis capabilities

## Artifacts Generated

### 1. JSON Report (`threat-report.json`)

```json
{
  "timestamp": "2026-02-11T14:20:15.000Z",
  "total_matched": 3,
  "total_resources": 4,
  "matched_threats": [
    {
      "threat_id": "aws-s3-001",
      "threat_name": "Public S3 Bucket",
      "description": "S3 bucket is configured to allow public access",
      "severity": "critical",
      "likelihood": "high",
      "risk_score": 9.5,
      "category": "Data Exposure",
      "resource_id": "aws_s3_bucket.app_data",
      "resource_type": "aws_s3_bucket",
      "cloud_provider": "AWS",
      "mitigations": [...],
      "compliance_mappings": [...]
    }
  ],
  "statistics": {
    "by_severity": {
      "critical": 2,
      "high": 1,
      "medium": 0,
      "low": 0
    },
    "average_risk_score": 9.2
  }
}
```

### 2. HTML Report

Beautiful, printable report with:
- Executive dashboard
- Color-coded threat cards
- Mitigation recommendations
- Compliance impact
- Ready for stakeholder review

### 3. Markdown Summary

```markdown
# Threat Analysis Summary

**Commit**: a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0
**Date**: 2026-02-11 14:20:15 UTC
**Event**: pull_request

## Results
- Total Threats: 3
- Critical: 2
- High: 1
- Medium: 0
- Low: 0
- Average Risk Score: 9.2

## Files Analyzed
infra/terraform/storage.tf
```

## Key Takeaways

### Security Benefits
âœ… **Early Detection**: Threats caught in PR, not production
âœ… **Automated**: No manual security review needed
âœ… **Actionable**: Clear mitigations and remediation steps
âœ… **Tracking**: Issues ensure threats aren't forgotten

### Developer Experience
âœ… **Fast Feedback**: Results in 2-3 minutes
âœ… **Clear Visibility**: PR comments and GitHub issues
âœ… **Non-blocking**: Can merge with warnings (optional)
âœ… **Educational**: Developers learn secure practices

### Compliance Value
âœ… **Audit Trail**: Full history in Git
âœ… **Evidence**: Automated detection and remediation
âœ… **Reporting**: Ready-made compliance reports
âœ… **Frameworks**: Maps to DORA, ISO27001, SOC2, GDPR

## Conclusion

This example demonstrates the complete workflow from introducing a security vulnerability to detecting, remediating, and verifying the fixâ€”all automatically through GitHub Actions. The developer received immediate feedback, clear remediation guidance, and the organization gained a complete audit trail of the security process.

**Result**: Secure infrastructure deployed to production with zero manual security reviews. ğŸ‰
